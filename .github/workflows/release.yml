name: Add Tags to Release

on:
  release:
    types: [published]

jobs:
  build-if-needed:
    if: github.repository == 'rht-labs/lodestar-hosting'
    runs-on: ubuntu-latest
    steps:
    - name: Check whether we need to build this or not
      id: need_to_build
      env:
        IMAGE_NAME: lodestar-hosting
        TAGS: main ${{ github.sha }}
      run: |
        function image_exists() {
            curl --silent -f -lSL https://quay.io/v1/repositories/rht-labs/lodestar-hosting/tags/$1 > /dev/null
        }
        if image_exists ${{ github.sha }}; then
            echo "Image exists - not building"
            echo ::set-output name=need_to_build::0
        else 
            echo "Image needs to be built"
            echo ::set-output name=need_to_build::1
        fi
    - uses: actions/checkout@v2
      if: steps.need_to_build.outputs.need_to_build == 1
    - name: Setup and Build
      id: build_image
      uses: redhat-actions/s2i-build@v2
      with:
        path_context: '.'
        # Builder image for a java project
        builder_image: 'registry.access.redhat.com/openjdk/openjdk-11-rhel7'
        image: ${{ env.IMAGE_NAME }}
        tags: ${{ env.TAGS }}
    - name: Push To Quay 
      uses: redhat-actions/push-to-registry@v2
      with:
        image: ${{ steps.build_image.outputs.image }}
        tags: ${{ steps.build_image.outputs.tags }}
        registry: quay.io/${{ secrets.QUAY_USERNAME }}
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

  release:
    runs-on: ubuntu-latest
    needs: build-if-needed
    steps:
    - uses: actions/checkout@v2
    - name: tag with release version
      uses: tinact/docker.image-retag@1.0.2
      with:
        image_name: rht-labs/lodestar-hosting
        image_old_tag: ${{ github.sha }}
        image_new_tag: ${{ github.event.release.tag_name }}
        registry: quay.io
        registry_username: ${{ secrets.QUAY_USERNAME }}
        registry_password: ${{ secrets.QUAY_PASSWORD }}
    - name: tag with latest
      uses: tinact/docker.image-retag@1.0.2
      with:
        image_name: rht-labs/lodestar-hosting
        image_old_tag: ${{ github.sha }}
        registry: quay.io
        registry_username: ${{ secrets.QUAY_USERNAME }}
        registry_password: ${{ secrets.QUAY_PASSWORD }}
